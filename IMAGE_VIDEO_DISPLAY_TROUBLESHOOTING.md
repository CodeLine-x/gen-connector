# 🔧 Image & Video Display Troubleshooting Guide

## 🐛 Common Issues & Fixes

### **Issue 1: Images Not Displaying**

#### **Symptoms:**

- ✅ Image generation succeeds in logs
- ❌ Image doesn't appear in UI
- ❌ Broken image icon or blank space

#### **Possible Causes & Solutions:**

---

#### **1.1 Next.js Image Domain Not Configured**

**Check:** Open browser console, look for:

```
Error: Invalid src prop (https://xxx.blob.vercel-storage.com/...)
hostname "xxx.blob.vercel-storage.com" is not configured under images in your next.config.js
```

**Fix:** Already fixed in `next.config.ts`:

```typescript
images: {
  remotePatterns: [
    {
      protocol: "https",
      hostname: "**.public.blob.vercel-storage.com",
    },
  ],
}
```

**Action:** Restart dev server after changing `next.config.ts`

---

#### **1.2 Vercel Blob Upload Failed**

**Check console logs for:**

```
❌ Error downloading and uploading to blob: ...
Upload API error: ...
```

**Common Issues:**

- `BLOB_READ_WRITE_TOKEN` not set in `.env`
- Token has wrong permissions
- Token expired

**Fix:**

1. Check `.env` file has `BLOB_READ_WRITE_TOKEN`
2. Get new token from Vercel dashboard: Settings → Blob → Tokens
3. Ensure token has READ & WRITE permissions
4. Restart dev server

---

#### **1.3 Fal.ai URL Expired Before Download**

**Check console logs for:**

```
✅ Image generated by Fal.ai
📥 Downloading and uploading to Vercel Blob...
❌ Failed to download file: 403 Forbidden
```

**Fix:** This is rare but can happen if Fal.ai generation is slow. The code already handles this with retry logic.

---

#### **1.4 State Not Updating**

**Check console logs for:**

```
✅ Image generated for segment 1
📍 Image URL: https://...
📍 Updated segments: [...]
```

**If you see the URL but image doesn't show:**

**Fix:**

1. Check if `segment.generatedImageUrl` is set in React DevTools
2. Check if segment ID matches between generation and display
3. Look for React key warnings in console

---

### **Issue 2: Video Not Playing**

#### **Symptoms:**

- ✅ Video generation succeeds
- ❌ Video doesn't play
- ❌ Black screen or loading forever

#### **Possible Causes & Solutions:**

---

#### **2.1 Video Format Not Supported**

**Check:**

- Browser console for video codec errors
- Video URL in network tab

**Fix:** Fal.ai generates MP4, which should work in all browsers. If not:

```html
<video controls>
  <source src="{videoUrl}" type="video/mp4" />
  Your browser does not support the video tag.
</video>
```

---

#### **2.2 CORS Issues**

**Check network tab for:**

```
Access-Control-Allow-Origin header is missing
```

**Fix:** Vercel Blob automatically sets correct CORS headers. If you see this:

1. Check if URL is actually from Vercel Blob
2. Try accessing URL directly in browser
3. Check Vercel Blob settings

---

### **Issue 3: Placeholder Images Showing**

#### **Symptoms:**

- 🖼️ Gray placeholder image with text
- No actual generated content

#### **Check console logs:**

**If you see:**

```
⚠️ Image generation failed, using placeholder
```

**Possible causes:**

1. **Fal.ai API key invalid/expired**

   - Check `FAL_KEY` in `.env`
   - Test key with direct Fal.ai API call

2. **Fal.ai API quota exceeded**

   - Check Fal.ai dashboard for usage
   - Check billing status

3. **Image generation timeout**
   - Increase timeout in `falService.ts`
   - Check Fal.ai status page

---

## 🧪 Debugging Steps

### **Step 1: Check Console Logs**

Look for this sequence:

```
1. 🎨 Generating image for segment 1...
2. 🤖 Generating prompts with GPT-3.5-turbo...
3. ✅ Prompts generated successfully
4. 🎨 Generating image with Fal.ai nano-banana...
5. ✅ Image generated successfully
6. Raw Fal.ai result: {...}
7. ✅ Image generated by Fal.ai
8. 📥 Downloading and uploading to Vercel Blob...
9. ✅ Image stored permanently at: https://...
10. ✅ Image generated for segment 1
11. 📍 Image URL: https://...
12. 📍 Updated segments: [...]
13. 🖼️ Rendering image for segment 1: https://...
14. ✅ Image loaded for segment 1
```

**If any step is missing, that's where the problem is.**

---

### **Step 2: Test Image URL Directly**

1. Copy image URL from console logs
2. Open in new browser tab
3. Should show the image immediately

**If image doesn't load:**

- URL is broken → Check Vercel Blob upload
- 403 Forbidden → Check token permissions
- 404 Not Found → Upload failed silently

---

### **Step 3: Check Database**

```sql
SELECT * FROM generated_content
WHERE session_id = 'your-session-id'
ORDER BY created_at DESC
LIMIT 5;
```

**Expected:**

- `content_type` = 'image'
- `url` starts with `https://xxx.blob.vercel-storage.com/`
- `metadata` contains `originalFalUrl`, `width`, `height`

**If missing:**

- Check database insert code
- Check Supabase logs for errors
- Check RLS policies

---

### **Step 4: Use Debug Component**

The new `GeneratedImageDisplay` component shows:

- Loading spinner while image loads
- Error message if image fails
- Debug panel with URL and status

**To access debug info:**

1. Look for "Debug Info" dropdown under image
2. Click to expand
3. Check URL and status

---

## 🔍 Common Error Messages

### **"Failed to load image"**

**Meaning:** Image URL is valid but browser can't load it

**Checks:**

1. Open URL in new tab → Does it work?
2. Check browser console for CORS errors
3. Check Network tab for HTTP status

---

### **"Image result: null"**

**Meaning:** Fal.ai generation returned null (failed after retry)

**Fixes:**

1. Check Fal.ai API key
2. Check Fal.ai quota
3. Check prompt quality (might be flagged by safety checker)

---

### **"Upload API error: Failed to upload file"**

**Meaning:** Vercel Blob upload failed

**Fixes:**

1. Check `BLOB_READ_WRITE_TOKEN`
2. Check Vercel Blob storage quota
3. Check file size (max 500MB per file)

---

## ✅ Quick Fixes Checklist

- [ ] **Restart dev server** after changing `next.config.ts`
- [ ] **Check `.env` file** has all required keys:
  - `FAL_KEY`
  - `BLOB_READ_WRITE_TOKEN`
  - `OPENAI_API_KEY`
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- [ ] **Clear browser cache** (Cmd/Ctrl + Shift + R)
- [ ] **Check browser console** for errors
- [ ] **Check network tab** for failed requests
- [ ] **Test image URLs directly** in browser
- [ ] **Check Supabase database** for stored URLs
- [ ] **Check Vercel Blob dashboard** for uploaded files

---

## 📊 Expected Behavior

### **Image Generation (per segment):**

1. Segment completes → Diarization done
2. "🎨 Generating image..." appears in console
3. Takes ~5-10 seconds
4. Loading spinner shows in UI
5. Image appears and fades in
6. Debug panel available under image

### **Video Generation (end of session):**

1. User clicks "End Session & Generate Video"
2. "🎬 Generating video..." appears in console
3. Takes ~15-30 seconds
4. Alert shows "Video generation in progress..."
5. Video opens in new tab when done
6. Stored in database for future viewing

---

## 🆘 Still Not Working?

### **Get More Debug Info:**

1. **Enable verbose logging in browser:**

   ```javascript
   localStorage.setItem("debug", "*");
   ```

2. **Check Vercel Blob files:**

   - Go to Vercel dashboard
   - Storage → Blob
   - Check if files are actually uploaded

3. **Test Fal.ai directly:**

   ```bash
   curl https://fal.run/fal-ai/nano-banana \
     -H "Authorization: Key YOUR_FAL_KEY" \
     -H "Content-Type: application/json" \
     -d '{"prompt": "A test image"}'
   ```

4. **Check Supabase logs:**
   - Go to Supabase dashboard
   - Logs → Database
   - Look for insert errors

---

## 💡 Pro Tips

1. **Images load slowly on first view** - Normal, they're downloading from Fal.ai
2. **Images load instantly on refresh** - They're cached in Vercel Blob
3. **Use "Debug Info" panel** - Shows exact URL and load status
4. **Check console logs first** - 90% of issues are visible there
5. **Test URLs directly** - Fastest way to isolate the problem

---

## 📝 Report Issues

If you're still having problems, provide:

1. **Console logs** (full sequence from step 1-14 above)
2. **Image URL** (from debug panel)
3. **Network tab screenshot** (showing failed request)
4. **Database query result** (generated_content table)
5. **Error message** (exact text from console)

This will help diagnose the issue quickly! 🚀
